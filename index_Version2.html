<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Laberinto Online 2 Jugadores</title>
    <style>
        #panel { margin:20px auto; display:block; }
        .msg { text-align:center }
        #creado { 
            text-align: center; 
            margin-top: 10px; 
            font-family: 'Arial Rounded MT Bold',Arial,sans-serif;
            font-size: 18px;
            color: #444;
            letter-spacing: 1.5px;
        }
    </style>
</head>
<body>
    <div class="msg" id="info"></div>
    <canvas id="panel" width="250" height="250"></canvas>
    <div id="creado">Creado por Jose y Omar</div>
    <script>
        let maze, players, turno, myId;
        const size = 50;
        const ctx = panel.getContext('2d');
        let ws = new WebSocket("ws://localhost:3000");
        ws.onmessage = msg => {
            const data = JSON.parse(msg.data);
            if (data.type === "full") {
                info.innerText = "¡Límite de jugadores!";
                return;
            }
            if (data.type === "init") {
                myId = data.id;
                maze = data.state.maze;
                players = data.state.players;
                turno = data.state.turno;
                draw();
                info.innerText = "Esperando al segundo jugador...";
            }
            if (data.type === "start") {
                info.innerText = "¡Empieza el juego!";
            }
            if (data.type === "update") {
                maze = data.state.maze;
                players = data.state.players;
                turno = data.state.turno;
                draw();
            }
        };
        function drawMaze() {
            for(let y=0;y<5;y++)for(let x=0;x<5;x++) {
                ctx.fillStyle = maze[y][x]===1 ? "#000" : "#fff";
                ctx.fillRect(x*size, y*size, size, size);
                if (maze[y][x]===2) {
                    ctx.fillStyle="#FC0";
                    ctx.beginPath();
                    ctx.arc(x*size+25,y*size+25,15,0,2*Math.PI);
                    ctx.fill();
                    ctx.font="20px sans-serif";
                    ctx.textAlign="center";
                    ctx.textBaseline="middle";
                    ctx.fillStyle="#CA9800";
                    ctx.fillText("⭐", x*size+25, y*size+24);
                }
                ctx.strokeStyle = "#777";
                ctx.strokeRect(x*size, y*size, size, size);
            }
        }
        function drawPlayer(px, py, color, withOutline, leftEyeColor="#222", rightEyeColor="#222") {
            // Draw body
            ctx.save();
            ctx.translate(px*size+25, py*size+25);
            // Outline
            if (withOutline) {
                ctx.save();
                ctx.strokeStyle="#111";
                ctx.lineWidth=3;
                ctx.beginPath();
                ctx.arc(0, 8, 13, 0, 2*Math.PI);
                ctx.stroke();
                ctx.restore();
            }
            // Body
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.ellipse(0, 10, 13, 16, 0, 0, 2*Math.PI);
            ctx.fill();
            // Head
            ctx.beginPath();
            ctx.arc(0, -7, 13, 0, 2*Math.PI);
            ctx.fill();
            // Head outline
            if (withOutline) {
                ctx.save();
                ctx.strokeStyle="#333";
                ctx.lineWidth=2;
                ctx.beginPath();
                ctx.arc(0, -7, 13, 0, 2*Math.PI);
                ctx.stroke();
                ctx.restore();
            }
            // Eyes
            ctx.fillStyle = leftEyeColor;
            ctx.beginPath();
            ctx.ellipse(-4, -10, 2.5, 3.7, 0, 0, 2*Math.PI);
            ctx.fill();
            ctx.fillStyle = rightEyeColor;
            ctx.beginPath();
            ctx.ellipse(4, -10, 2.5, 3.7, 0, 0, 2*Math.PI);
            ctx.fill();
            // Smile
            ctx.strokeStyle="#111";
            ctx.lineWidth=1.2;
            ctx.beginPath();
            ctx.arc(0, -2, 6, 0.23*Math.PI, 0.77*Math.PI);
            ctx.stroke();
            ctx.restore();
        }
        function draw() {
            ctx.clearRect(0,0,250,250);
            drawMaze();
            // Jugador 1 (verde con ojos negros)
            if(players[0])
                drawPlayer(players[0].x, players[0].y, "#3bb551", true, "#111", "#111");
            // Jugador 2 (azul con ojos azules oscuros)
            if(players[1])
                drawPlayer(players[1].x, players[1].y, "#298bf0", true, "#05294d", "#05294d");
            let msg = `Puntajes: `;
            msg+=`J1(verde):${players[0]?.score||0} `;
            msg+=`| J2(azul):${players[1]?.score||0} `;
            msg+=`| Turno: Jugador ${turno+1} `;
            msg+=(turno===myId?'(¡Tuyo!)':'');
            info.innerText = msg;
        }
        document.addEventListener('keydown',e=>{
            if(turno!==myId) return;
            let dx=0,dy=0;
            // Jugador 1: WASD, Jugador 2: Flechas
            if (myId===0) {
                if(e.key==='w')dy=-1;if(e.key==='s')dy=1;if(e.key==='a')dx=-1;if(e.key==='d')dx=1;
            } else {
                if(e.key==="ArrowUp")dy=-1;if(e.key==="ArrowDown")dy=1;if(e.key==="ArrowLeft")dx=-1;if(e.key==="ArrowRight")dx=1;
            }
            if(dx||dy)ws.send(JSON.stringify({type:"move", id:myId, dx, dy}));
        });
    </script>
</body>
</html>